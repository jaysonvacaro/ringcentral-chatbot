{"version":3,"sources":["../../src/apps/admin.js"],"names":["createApp","handle","app","use","users","process","env","RINGCENTRAL_CHATBOT_ADMIN_USERNAME","RINGCENTRAL_CHATBOT_ADMIN_PASSWORD","unauthorizedResponse","req","put","res","Bot","sync","Service","type","send","bots","findAll","bot","check","ensureWebHook","services","service","get","result","JSON","stringify","subscriptions","getSubscriptions"],"mappings":";;;;;;;AAAA;;AACA;;AAEA;;;;AAEA,MAAMA,SAAS,GAAGC,MAAM,IAAI;AAC1B,QAAMC,GAAG,GAAG,uBAAZ;AACAA,EAAAA,GAAG,CAACC,GAAJ,CAAQ,+BAAU;AAChBC,IAAAA,KAAK,EAAE;AACL,OAACC,OAAO,CAACC,GAAR,CAAYC,kCAAb,GAAkDF,OAAO,CAACC,GAAR,CAAYE;AADzD,KADS;AAIhBC,IAAAA,oBAAoB,EAAEC,GAAG,IAAI;AAJb,GAAV,CAAR,EAF0B,CAS1B;;AACAR,EAAAA,GAAG,CAACS,GAAJ,CAAQ,iBAAR,EAA2B,OAAOD,GAAP,EAAYE,GAAZ,KAAoB;AAC7C,UAAMC,YAAIC,IAAJ,EAAN;AACA,UAAMC,gBAAQD,IAAR,EAAN;AACA,UAAMb,MAAM,CAAC;AAAEe,MAAAA,IAAI,EAAE;AAAR,KAAD,CAAZ;AACAJ,IAAAA,GAAG,CAACK,IAAJ,CAAS,EAAT;AACD,GALD,EAV0B,CAiB1B;;AACAf,EAAAA,GAAG,CAACS,GAAJ,CAAQ,WAAR,EAAqB,OAAOD,GAAP,EAAYE,GAAZ,KAAoB;AACvC,UAAMM,IAAI,GAAG,MAAML,YAAIM,OAAJ,EAAnB;;AACA,SAAK,MAAMC,GAAX,IAAkBF,IAAlB,EAAwB;AACtB,UAAI,MAAME,GAAG,CAACC,KAAJ,EAAV,EAAuB;AACrB,cAAMD,GAAG,CAACE,aAAJ,EAAN;AACD;AACF;;AACD,UAAMC,QAAQ,GAAG,MAAMR,gBAAQI,OAAR,EAAvB;;AACA,SAAK,MAAMK,OAAX,IAAsBD,QAAtB,EAAgC;AAC9B,YAAMC,OAAO,CAACH,KAAR,EAAN;AACD;;AACD,UAAMpB,MAAM,CAAC;AAAEe,MAAAA,IAAI,EAAE;AAAR,KAAD,CAAZ;AACAJ,IAAAA,GAAG,CAACK,IAAJ,CAAS,EAAT;AACD,GAbD,EAlB0B,CAiC1B;;AACAf,EAAAA,GAAG,CAACuB,GAAJ,CAAQ,aAAR,EAAuB,OAAOf,GAAP,EAAYE,GAAZ,KAAoB;AACzC,UAAMM,IAAI,GAAG,MAAML,YAAIM,OAAJ,EAAnB;AACA,QAAIO,MAAM,GAAG,EAAb;;AACA,SAAK,MAAMN,GAAX,IAAkBF,IAAlB,EAAwB;AACtBQ,MAAAA,MAAM,IAAI,qBAAV;AACAA,MAAAA,MAAM,IAAK,UAASC,IAAI,CAACC,SAAL,CAAeR,GAAf,EAAoB,IAApB,EAA0B,CAA1B,CAA6B,YAAjD;AACA,YAAMS,aAAa,GAAG,MAAMT,GAAG,CAACU,gBAAJ,EAA5B;AACAJ,MAAAA,MAAM,IAAK,UAASC,IAAI,CAACC,SAAL,CAAeC,aAAf,EAA8B,IAA9B,EAAoC,CAApC,CAAuC,YAA3D;AACAH,MAAAA,MAAM,IAAI,qBAAV;AACD;;AACDA,IAAAA,MAAM,IAAI,aAAV;AACA,UAAMH,QAAQ,GAAG,MAAMR,gBAAQI,OAAR,EAAvB;;AACA,SAAK,MAAMK,OAAX,IAAsBD,QAAtB,EAAgC;AAC9BG,MAAAA,MAAM,IAAK,UAASC,IAAI,CAACC,SAAL,CAAeJ,OAAf,EAAwB,IAAxB,EAA8B,CAA9B,CAAiC,aAArD;AACD;;AACDZ,IAAAA,GAAG,CAACK,IAAJ,CAASS,MAAT;AACD,GAhBD;AAkBA,SAAOxB,GAAP;AACD,CArDD;;eAuDeF,S","sourcesContent":["import express from 'express'\nimport basicAuth from 'express-basic-auth'\n\nimport { Bot, Service } from '../models'\n\nconst createApp = handle => {\n  const app = express()\n  app.use(basicAuth({\n    users: {\n      [process.env.RINGCENTRAL_CHATBOT_ADMIN_USERNAME]: process.env.RINGCENTRAL_CHATBOT_ADMIN_PASSWORD\n    },\n    unauthorizedResponse: req => '401 Unauthorized'\n  }))\n\n  // create database tables if not exists\n  app.put('/setup-database', async (req, res) => {\n    await Bot.sync()\n    await Service.sync()\n    await handle({ type: 'SetupDatabase' })\n    res.send('')\n  })\n\n  // \"maintain\": remove dead bots from database, ensure live bots have WebHooks\n  app.put('/maintain', async (req, res) => {\n    const bots = await Bot.findAll()\n    for (const bot of bots) {\n      if (await bot.check()) {\n        await bot.ensureWebHook()\n      }\n    }\n    const services = await Service.findAll()\n    for (const service of services) {\n      await service.check()\n    }\n    await handle({ type: 'Maintain' })\n    res.send('')\n  })\n\n  // provide administrator with diagnostic information for troubleshooting\n  app.get('/diagnostic', async (req, res) => {\n    const bots = await Bot.findAll()\n    let result = ''\n    for (const bot of bots) {\n      result += '*****************\\n'\n      result += `<pre>\\n${JSON.stringify(bot, null, 2)}\\n</pre>\\n`\n      const subscriptions = await bot.getSubscriptions()\n      result += `<pre>\\n${JSON.stringify(subscriptions, null, 2)}\\n</pre>\\n`\n      result += '*****************\\n'\n    }\n    result += '\\n<hr/>\\n\\n'\n    const services = await Service.findAll()\n    for (const service of services) {\n      result += `<pre>\\n${JSON.stringify(service, null, 2)}}\\n</pre>\\n`\n    }\n    res.send(result)\n  })\n\n  return app\n}\n\nexport default createApp\n"],"file":"admin.js"}